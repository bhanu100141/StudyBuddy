generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  TEACHER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chats              Chat[]
  materials          Material[]
  courses            Course[]
  schedules          Schedule[]
  assignmentsCreated Assignment[] @relation("TeacherAssignments")
  assignmentsReceived Assignment[] @relation("StudentAssignments")
  doubtsAsked        Doubt[]      @relation("StudentDoubts")
  doubtsAnswered     Doubt[]      @relation("TeacherDoubts")
  preferredDoubts    Doubt[]      @relation("PreferredTeacherDoubts")
  meetingsRequested  MeetingRequest[] @relation("StudentMeetings")
  meetingsHosted     MeetingRequest[] @relation("TeacherMeetings")
  preferredMeetings  MeetingRequest[] @relation("PreferredTeacherMeetings")
}

model Material {
  id        String   @id @default(uuid())
  userId    String
  fileName  String
  fileUrl   String
  fileType  String
  fileSize  Int
  content   String?  @db.Text
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Chat {
  id        String   @id @default(uuid())
  userId    String
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
}

model Message {
  id           String   @id @default(uuid())
  chatId       String
  role         String   // "user" or "assistant"
  content      String   @db.Text
  createdAt    DateTime @default(now())

  // File attachment fields
  hasAttachment Boolean  @default(false)
  fileName      String?
  fileUrl       String?
  fileType      String?
  fileSize      Int?
  fileContent   String?  @db.Text // Extracted text content from file

  chat          Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
}

enum ScheduleType {
  CLASS
  ASSIGNMENT
  EXAM
  TASK
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum AssignmentType {
  TASK
  EXAM
  QUIZ
  PROJECT
}

enum AssignmentStatus {
  PENDING
  SUBMITTED
  GRADED
  OVERDUE
}

enum DoubtStatus {
  OPEN
  ANSWERED
  CLOSED
}

enum MeetingStatus {
  REQUESTED
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum MeetingType {
  DOUBT_CLARIFICATION
  EXAM
  DISCUSSION
}

model Course {
  id          String   @id @default(uuid())
  userId      String
  name        String
  code        String?
  instructor  String?
  color       String   @default("#3B82F6") // Hex color for UI
  credits     Int?
  semester    String?
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules   Schedule[]

  @@index([userId])
}

model Schedule {
  id          String       @id @default(uuid())
  userId      String
  courseId    String?
  title       String
  description String?      @db.Text
  type        ScheduleType @default(OTHER)
  date        DateTime
  startTime   String?      // Format: "HH:MM"
  endTime     String?      // Format: "HH:MM"
  location    String?
  isCompleted Boolean      @default(false)
  priority    Priority     @default(MEDIUM)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course?      @relation(fields: [courseId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([courseId])
  @@index([date])
}

model Assignment {
  id          String           @id @default(uuid())
  teacherId   String
  studentId   String
  title       String
  description String           @db.Text
  type        AssignmentType
  status      AssignmentStatus @default(PENDING)
  dueDate     DateTime
  totalMarks  Int?
  marksObtained Int?
  submissionUrl String?
  submissionText String?        @db.Text
  feedback    String?          @db.Text
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  teacher     User             @relation("TeacherAssignments", fields: [teacherId], references: [id], onDelete: Cascade)
  student     User             @relation("StudentAssignments", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([studentId])
  @@index([status])
  @@index([dueDate])
}

model Doubt {
  id          String      @id @default(uuid())
  studentId   String
  teacherId   String?
  preferredTeacherId String?
  subject     String
  question    String      @db.Text
  answer      String?     @db.Text
  status      DoubtStatus @default(OPEN)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  student     User        @relation("StudentDoubts", fields: [studentId], references: [id], onDelete: Cascade)
  teacher     User?       @relation("TeacherDoubts", fields: [teacherId], references: [id], onDelete: SetNull)
  preferredTeacher User?   @relation("PreferredTeacherDoubts", fields: [preferredTeacherId], references: [id], onDelete: SetNull)
  meetingRequest MeetingRequest?

  @@index([studentId])
  @@index([teacherId])
  @@index([preferredTeacherId])
  @@index([status])
}

model MeetingRequest {
  id          String        @id @default(uuid())
  studentId   String
  teacherId   String?
  preferredTeacherId String?
  doubtId     String?       @unique
  type        MeetingType
  status      MeetingStatus @default(REQUESTED)
  subject     String
  description String        @db.Text
  scheduledAt DateTime?
  meetLink    String?
  duration    Int?          // Duration in minutes
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  student     User          @relation("StudentMeetings", fields: [studentId], references: [id], onDelete: Cascade)
  teacher     User?         @relation("TeacherMeetings", fields: [teacherId], references: [id], onDelete: SetNull)
  preferredTeacher User?     @relation("PreferredTeacherMeetings", fields: [preferredTeacherId], references: [id], onDelete: SetNull)
  doubt       Doubt?        @relation(fields: [doubtId], references: [id], onDelete: SetNull)

  @@index([studentId])
  @@index([teacherId])
  @@index([preferredTeacherId])
  @@index([status])
  @@index([scheduledAt])
}
